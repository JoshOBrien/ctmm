---
title: "Telemetry error"
author: "Christen H. Fleming"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteKeyword{error}
  %\VignetteIndexEntry{Dealing with telemetry error}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  \usepackage[utf8]{inputenc}
---

# Error calibration

The first step to handling errors is to quantify them. Make sure that your data's "dilution of precision" (DOP) and error columns import correctly into `ctmm`. Some tracking device manufacturers provide pre-calibrated errors. These coati were tracked with e-obs GPS collars that features calibrated errors for the location, imported by `ctmm` into the `VAR.xy` column, which represents the `x` and `y` error variances.

```{r, include=FALSE}
knit_print.list <- function(x, ...) {
  res = paste(c("## ", x), collapse = "\n")
  knitr::asis_output(res)
}
```


```{r}
library(ctmm)
data('coati')
names(coati[[1]]) # imported column names
```

Most GPS devices will only have an `HDOP` column, which is only proportional to the `x` and `y` error standard deviations. The proportionality constant between the HDOP and error standard deviation is known as the user equivalent range error (UERE). The UERE should be estimated from calibration data if not provided by the manufacturer. Without the option of pre-calibrated errors or calibration data, the UERE must be fit simultaneously with the movement model, which is not as reliable. We will cover simultaneous fitting at the end of this vignette.

In the following wood turtle dataset, we have some calibration data and a turtle track. Note that the calibration data must be collected from the same model device as the tracking data.

```{r}
data(turtle)
names(turtle[[1]]) # data are not yet calibrated
names(turtle) # two calibration datasets and two turtle datasets
```

The `uere` command is used to estimate the UERE parameter from calibration data. Do not use this command on animal tracking data.

```{r}
UERE <- uere.fit(turtle[1:2]) # only using calibration data
summary(UERE)
```

For GPS data, the UERE will typically be 10-15 meters. The UERE can be assigned to a dataset with the `uere()<-` command.

```{r}
uere(turtle) <- UERE
names(turtle[[3]]) # now the data are calibrated
```

## Error model selection

Not all GPS devices provide reliable DOP values and sometimes it is not obvious what error information will prove to be the most predictive. Generally speaking, `as.telemetry` will attempt to import the "best" column from among those that estimate error, DOP value, number of satellites and fix type, inlcuding timed-out fixes (see the `timeout` argument in `help(as.telemetry)`). Researchers may want to import the data with different error information, run `uere.fit` for each error model, and then select among the candidate models. Here we do this by comparing the turtle calibration data with and without HDOP values.

First, we remove the HDOP values in an alternate dataset.
```{r}
squirtle <- lapply(turtle,function(t){ t$HDOP <- NULL ; t })
```
In other cases, manipulation will need to be performed before importing, so that `as.telemetry` can format the `telemetry` object properly.
Running `uere.fit` now results in errors calibrated under the assumption of homoskedastic errors.
```{r}
UERE2 <- uere.fit(squirtle[1:2])
```
We can now apply model selection to the two UERE fits by summarizing them in a list.
```{r}
cat(c("\u0394AICc","Z[red]\u00B2"))
cat("Z[red]\u00B2","\n")
knitr::asis_output("\u00B2Z[red]\u00B2")
summary(list(HDOP=UERE,homo=UERE2))
res <- summary(list(HDOP=UERE,homo=UERE2))
dimnames(res)[[2]] <- sapply(c("\u0394AICc", "Z[red]\u00B2"), enc2utf8)
knitr::asis_output(res)
printed <- capture.output(print(res))
cat(paste(printed, collapse = "\n"))
u_str <- enc2utf8("\u0394AICc Z[red]\u00B2")
knitr::asis_output(u_str)
knitr::asis_output(print(res))
```
Now we can see that the HDOP values yield the better error model,
both in terms of AICc and in terms of reduced Z squared, which is a goodness-of-fit statistic akin to reduced chi squared but designed for comparing error models.

```{r}
  y = character()
  con = textConnection('y', local = TRUE, open = 'wr')
  sink(con)
  print(res)
  sink()
  y
  knitr::asis_output(y)
```


```{r eval=FALSE}
knitr::knit("D:/Work/R/ctmm/vignettes/error.Rmd")
```

